#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Check if templates, config, or maps have changed
CHANGED_FILES=$(git diff --cached --name-only)

# Check if any critical files that affect generation have changed
if echo "$CHANGED_FILES" | grep -qE "^(templates/|config/maps\.config\.json|maps/.*\.json)"; then
  echo "‚ö†Ô∏è  Detected changes to templates, configuration, or map files"
  echo "üîÑ Verifying package generation status..."
  
  # Run verification script
  if ! node scripts/verify-packages.js; then
    echo ""
    echo "‚ùå Pre-commit check failed!"
    echo ""
    echo "Templates, configuration, or map files have changed, but generated packages are out of date."
    echo ""
    echo "Please run the following command to regenerate packages:"
    echo "  pnpm generate"
    echo ""
    echo "Then stage the changes and commit again:"
    echo "  git add ."
    echo "  git commit"
    echo ""
    exit 1
  fi
  
  echo "‚úÖ Package generation verification passed"
else
  echo "‚ÑπÔ∏è  No template/config changes detected, skipping generation check"
fi

echo "‚úÖ Pre-commit checks passed"

